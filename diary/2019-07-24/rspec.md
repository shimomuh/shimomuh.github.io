# プロジェクトの途中から膨大なコードの品質を保証したくて rspec を導入する

タグ `このサイトの生い立ち` `Ruby` `設計`

## 対象者

プロジェクト始まってるけど rspec を入れようという人

## 背景

TDD とかやる人間なので、テストなしの品質保証は正直やめたかった

考慮漏れはまだしも考慮してたかどうかを保証したかったので導入した

~あと、正規表現苦手なので~

 

加えてタイミング的なこともあった

もちろん最初から入れておくのがベストだが、スタートアップとかだとなおのこと、予算もなければ工数もヒューマンリソースもないなんてことはザルだと思う

僕もまずは完成を優先させたかったので今まで書いてこなかったが、少し落ち着いたのと、ちょうど帰省中の新幹線の中でネットワークなしにできそうなことを考えて今回のテスト実施に至った

## 結果

[→成果](https://github.com/shimomuh/shimomuh.github.io/commit/8a2d40362a68a0b68d606bc5810df892529b4c21)

ネットワークほぼない状態で書くことを書いたので新しい知識はなかったので共有することは少ないが、テストをどうやったかという話をしよう

 

まずテストをやるからには網羅的にやる必要がある

むしろ網羅的にやらず不安なところだけやるというのも手だが、個人的には全部やったほうがいいと思っている

とはいえ、全部は無理なことも多いだろう

そこで今回は pending を使って、機能を網羅的にテストするようにした

* 考慮しているものは全て書いたはずなので、考慮漏れがあるとすればテストケースがないはずだ
* pending を使うことで理想はこの機能を対応したいが、現状は乖離しているということを自明にした
* 同じテストは省く意味でコメントを多く残し、他でやっているテストはそっちで担保すると明示することで書く量を減らした

成果の一部を抜粋すると以下のような感じだ

```ruby
RSpec.describe ClassA do
  describe '.methodA' do
    # 網羅的に書き出す
    #
    context 'M のとき' do
      it 'methodA は m を返す'
    end

    context 'N のとき' do
      it 'methodA は例外を返す'
    end

    context 'O のとき' do
      # 未実装の場合は理想と現実の gap を書く
      #
      pending '本当はこうしたい（けど今はこんな感じで fail する）'
    end
  end

  describe '.methodB' do
    # 自明なものはこういう理由で割愛してると書いてあげる
    #
    it 'このテストは内部で ClassB の methodC を delegate しているだけなので割愛'
  end

  # このようにコメントだけ残すのもあり
  # この場合はテストに出てこないので可能な限り理由が表示される形でテストしておくほうがよい
  describe '.methodC' do
    # このクラスは内部で ClassC の methodA を delegate しているので割愛
  end
end
```

あとは `bundle exec rspec --format documentation` してあげれば、どういう理由で PENDING なのか、 PASS しているのかがわかるのでおすすめ
